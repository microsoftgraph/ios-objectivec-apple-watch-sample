# Кто вы? - Пример для Microsoft Graph и Apple Watch

**Кто вы?** — это пример приложения для часов, которое позволяет узнать больше о коллеге во время собрания. Вы можете объединить носимое устройство, например Apple Watch, с Microsoft Graph, единой конечной точкой для доступа к данным, отношениям и данным, полученным с помощью Microsoft Cloud.

В этом сценарии показано, как получить доступ к собранию с неизвестными вам участниками, о которых вы хотите получить сведения, не привлекая лишнего внимания. С помощью Apple Watch вы можете открыть список участников собрания и просмотреть сведения в их профилях, такие как должность, руководитель, подчиненные и изображения профиля.

![Часы](https://github.com/microsoftgraph/iOS-objectiveC-apple-watch-sample/blob/master/Images/WatchScene.jpg)


> Примечание. Это всего лишь пример того, как интегрировать Microsoft Graph в различных сценариях и воспользоваться соответствующими возможностями. Как всегда, при создании собственного приложения в организации необходимо придерживаться собственных рекомендаций в отношении безопасности (проверка подлинности приложения и назначенные ему разрешения) и дизайна приложения. Кроме того, обратитесь к [рекомендациям Apple относительно человеко-машинного интерфейса watchOS](https://developer.apple.com/watch/human-interface-guidelines/).

Наконец, мы продолжаем работу в этом направлении и нуждаемся в отзывах от вас, что при необходимости улучшить наши наработки. **Кто вы?** — это пример WatchOS 2.2, в котором библиотека проверки подлинности Active Directory для iOS используется для проверки подлинности, а конечная точка Microsoft Graph — для сбора данных профилей пользователей. 

## Необходимые компоненты
* Среда [Xcode](https://developer.apple.com/xcode/downloads/) от Apple (протестирована в версии 7.3.1) с поддержкой WatchOS 2.2.
* Установка [CocoaPods](https://guides.cocoapods.org/using/using-cocoapods.html) в качестве диспетчера зависимостей.
* Рабочая учетная запись Майкрософт, например учетная запись Office 365, которая поддерживает Microsoft Exchange.  Вы можете оформить [пробную подписку на Office 365 корпоративный](https://products.office.com/en-us/business/office-365-enterprise-e5-business-software), которая включает ресурсы, необходимые для создания приложений Office 365. Она также включает 25 лицензий для пользователей.

     > Примечание. Для этого примера требуются лицензированные учетные записи организации, в которых указаны ограниченные сведения профилей, например должность сотрудника, отображаемое имя, руководитель, подчиненные и изображение профиля. Если эти сведения не заполнены, они не отобразятся в приложении.    
* Клиент Microsoft Azure для регистрации приложения. В Azure Active Directory доступны службы идентификации, которые приложения используют для проверки подлинности и авторизации. Здесь можно получить пробную подписку: [Microsoft Azure](https://account.windowsazure.com/SignUp).

**Важно!** Убедитесь, что ваша подписка на Azure привязана к клиенту Office 365. Для этого просмотрите раздел "Добавление нового каталога" записи в блоге команды Active Directory, в которой рассматривается [создание нескольких каталогов Windows Azure Active Directory и управление ими](http://blogs.technet.com/b/ad/archive/2013/11/08/creating-and-managing-multiple-windows-azure-active-directories.aspx). Чтобы получить дополнительные сведения, также можно ознакомиться со статьей о [настройке доступа к сайту разработчика с помощью Azure Active Directory](http://msdn.microsoft.com/office/office365/howto/setup-development-environment#bk_CreateAzureSubscription).


## Регистрация приложения в Microsoft Azure
1.  Войдите на [портал управления Azure](https://manage.windowsazure.com) с помощью учетных данных Azure AD.
2.  Щелкните **Все элементы** в левом меню, а затем выберите каталог для сайта разработчика Office 365.
3.  В верхнем меню выберите элемент **Приложения**.
4.  Выберите команду **Добавить** в нижнем меню.
5.  На странице **Что вы хотите сделать?** выберите команду **Добавить приложение, разрабатываемое моей организацией**.
6.  На странице **Расскажите о своем приложении** укажите имя приложения **iOS-Watch** и выберите тип **СОБСТВЕННОЕ КЛИЕНТСКОЕ ПРИЛОЖЕНИЕ**.
7.  Щелкните значок стрелки в правом нижнем углу страницы.
8.  На странице **Сведения о приложении** укажите **универсальный код ресурса (URI) перенаправления**. Например, укажите **https://localhost**, а затем выберите **значок флажка** в правом нижнем углу страницы. Запомните это значение для раздела **Запуск этого примера в Xcode**.
9.  После добавления приложения откроется страница его быстрого запуска. Выберите пункт **Настройка** в верхнем меню.
10. Перейдите к разделу **Разрешения для других приложений**.
11. Щелкните **Добавить приложение**.
12. Щелкните **Microsoft Graph**. 
13. Щелкните **значок флажка** в нижней части страницы.
14. В разделе **Делегированные разрешения** выберите **Вход и чтение профиля пользователя**, **Чтение полных профилей всех пользователей** и **Чтение календарей пользователей**.
15. Нажмите кнопку **Сохранить** в нижней части страницы.
16. Скопируйте значения для **идентификатора клиента** и **универсальные коды ресурсов (URI) перенаправления** на странице **Настройка**. Запомните эти значения для раздела **Запуск этого примера в Xcode**.

## Запуск этого примера в Xcode

1. Клонируйте этот репозиторий.
2. С помощью CocoaPods импортируйте зависимость проверки подлинности ADAL. Этот пример приложения уже содержит podfile, который добавит компоненты pod в проект. Просто перейдите к проекту из раздела **Терминал** и выполните следующую команду:

        pod install

     Чтобы получить дополнительные сведения, выберите ссылку **Использование CocoaPods** в разделе [Дополнительные ресурсы](#Дополнительные-ресурсы).

3. Откройте **iOS-ObjectiveC-MicrosoftGraph-WatchSample.xcworkspace**.
4. Откройте **ViewController.m**. Вы увидите, что в верхнюю часть файла можно добавить значения **идентификатора клиента** и **универсального кода ресурса (URI) перенаправления**, скопированные в ходе регистрации.

        // You will set your application's clientId and redirect URI.
        NSString * const kRedirectUri = @"ENTER_REDIRECT_URI_HERE";
        NSString * const kClientId    = @"ENTER_CLIENT_ID_HERE";
        NSString * const kAuthority   = @"https://login.microsoftonline.com/common";
        NSString * const kResourceId  = @"https://graph.microsoft.com";

5. Запустите пример и убедитесь, что в качестве целевого объекта задана схема WatchKit App iPhone/Apple Watch.
![Целевой объект](https://github.com/microsoftgraph/iOS-objectiveC-apple-watch-sample/blob/master/Images/target.jpg)
6. Убедитесь, что отображаются приложение IOS и симуляторы приложения для часов. В приложении на телефоне щелкните *Подключить*, после чего отобразится запрос на проверку подлинности для входа в учетную запись рабочей почты. Введите свои учетные данные.
![Проверка подлинности](https://github.com/microsoftgraph/iOS-objectiveC-apple-watch-sample/blob/master/Images/Authentication.jpg)
6. После проверки подлинности приложение для часов сразу попытается извлечь последние события из календаря пользователя, который вошел в систему. На экране часов отобразится индикатор **Получение...**. Отсюда можно детализировать список участников, найти интересующих вас пользователей и просмотреть сведения профиля, такие как должность, руководитель, подчиненные и изображения профиля.

    > Примечание. Напоминаем, что вам нужно использовать собрание, созданное с помощью клиента Office 365, добавить лицензированных участников и ввести некоторые сведения их профилей, чтобы приложение вернуло данные. Обязательно создавайте собрание с указанием отображаемого имени и должности в консоли администрирования Office 365. Подчиненных и руководителя можно назначить в Центре администрирования Exchange (получатели/почтовые ящики) в Office 365. Кроме того, ознакомьтесь с проблемой, связанной с маркером доступа, в разделе **Известные проблемы** ниже.

##Требуемый код

**Телефон**

*ViewController* — что касается телефона, именно здесь настраивается и активируется класс WCSession, позволяющий установить связь между телефоном и часами. Отсюда выполняется вызов в класс **AuthenticationManager** для маркера доступа (ADAL для iOS). Затем этот вызов отправляется на часы с помощью метода **sendMessage:replyHandler:errorHandler:**. 

**Часы**

*InterfaceController* — в этом контроллере реализуется метод **session:didReceiveMessageData:replyHandler:**, позволяющий получить с телефона маркер доступа, который сохраняется в расположении **Network\NetworkManager.m**. Затем этот контроллер выполняет вызов в службу Microsoft Graph, чтобы извлечь события в календаре пользователя, который вошел в систему (**getEvents**), и отобразить их. После этого пользователь выбирает собрание, а объект события в календаре передается контроллеру **AttendeeListController**.

*AttendeeListController* — этот контроллер отображает список участников собрания, а также их изображения профилей. При вызове в службу Microsoft Graph (**getEventAttendees**) создается или инициируется объект Attendee с именем участника, который затем передается контроллеру **ProfileController**, когда пользователь его выбирает. Кроме того, вспомогательный класс **ProfilePictureHelper** вызывает метод **getPhotoForAttendee:(Attendee *) withcompletion:**, чтобы извлечь изображения профилей всех участников собрания.
  
*ProfileController* — наконец, вызываются два дополнительных метода Microsoft Graph (**getUserManager, getUserDirects**), которые позволяют извлечь данные о руководителе, должности, подчиненных и связанных изображениях профиля выбранного участника.


##Известные проблемы
Напоминаем, что мы все еще работаем над этим проектом. В настоящее время маркер доступа, передаваемый между телефоном и часами, не обновляется при окончании срока действия. После окончания срока его действия вам нужно будет повторно войти в систему. На симуляторах можно просто повторно развернуть приложение. Однако если развернуть его на часах, приложение зависнет после окончания срока действия маркера. Вы можете повторно развернуть приложение на устройстве или завершить его работу в фоновом режиме, а затем перезапустить (для этого откройте приложение, нажмите боковую кнопку, пока не отобразится меню питания, снова удерживайте нажатой боковую кнопку, пока это меню не исчезнет, и перезапустите приложение).

## Вопросы и комментарии

Мы будем рады узнать ваше мнение о приложении **Кто вы?**. Вы можете отправлять нам вопросы и предложения на вкладке [Issues](https://github.com/microsoftgraph/iOS-objectiveC-apple-watch-sample/issues) (Проблемы) этого репозитория.

Общие вопросы о разработке решений для Microsoft Graph следует задавать на сайте [Stack Overflow](http://stackoverflow.com/questions/tagged/Office365+API). Обязательно помечайте свои вопросы и комментарии тегами [Office365] и [MicrosoftGraph].

## Участие
Прежде чем отправить запрос на включение внесенных изменений, необходимо подписать [лицензионное соглашение с участником](https://cla.microsoft.com/). Чтобы заполнить лицензионное соглашение с участником (CLA), вам потребуется отправить запрос с помощью формы, а затем после получения сообщения электронной почты со ссылкой на этот документ подписать CLA с помощью электронной подписи.

Этот проект соответствует [правилам поведения Майкрософт, касающимся обращения с открытым кодом](https://opensource.microsoft.com/codeofconduct/). Читайте дополнительные сведения в [разделе вопросов и ответов по правилам поведения](https://opensource.microsoft.com/codeofconduct/faq/) или отправляйте новые вопросы и замечания по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Дополнительные ресурсы

* [Страница с общими сведениями о Microsoft Graph](https://graph.microsoft.io)
* [Использование CocoaPods](https://guides.cocoapods.org/using/using-cocoapods.html)

## Авторское право
(c) Корпорация Майкрософт (Microsoft Corporation), 2016. Все права защищены.
